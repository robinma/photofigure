!function(a,b,c){"function"==typeof define&&(define.cmd||define.amd)?define(function(){return c(a,b)}):a.photofigure=c(a,b)}(window,$,function(a,b){var c=!!window.ActiveXObject&&!window.XMLHttpRequest,d=b(window),e=b("html"),f=(b("body"),{}),g={_handlers:"",on:function(a,b){return"object"!=typeof this._handlers&&(this._handlers=[]),this._handlers[a]||(this._handlers[a]=[]),"function"==typeof b&&this._handlers[a].push(b),this},emit:function(a){for(var b=Array.prototype.slice.call(arguments,1),c=this._handlers[a]||[],d=0,e=c.length;e>d;d++)c[d].apply(null,b);return this}},h=function(a,b){this.imgData=[],this.currIndex=0|b,this.init(a)};b.extend(h.prototype,g,{init:function(a){var b=this.filterData(a);this.imgData=this.imgData.concat(b),this.getWinWH();var c=this;setTimeout(function(){c._renderWarp()},0)},filterData:function(a){var c=[];return b.isArray(a)?c=c.concat(a):"object"==typeof a&&c.push(a),c}}),b.extend(h.prototype,{$_warp:"",$_figbox:"",_renderWarp:function(){var a='<div class="photo_figure_layer">						<div class="photo_bg_layer"></div>							<div class="photo_figure_main">								<a href="javascript:;" class="closebtn"><em class="pficon"></em></a>								<div class="photo_figure_box"></div>							</div>					</div>';this._setHidden();var c=b(a);this.$_warp=c,this._setPosition(),e.append(c),this.$_figbox=c.find(".photo_figure_box"),this._warpControl(),this._renderPhotoShow(),this._setBoxSize(),this._renderGallary()},_setHidden:function(){e.css({overflow:"hidden"})},_setVisible:function(){e.css({overflow:"visible"})},_warpControl:function(){var a=this;this.$_warp.on("click","a.closebtn",function(){a._setVisible(),a.$_warp.remove()})},_setPosition:function(){if(c){var a=d.scrollTop();this.$_warp.css({position:"absolute",top:a,left:0})}else this.$_warp.css({position:"fixed",top:0,left:0})},getWinWH:function(){f.winWidth=d.width(),f.winHeight=d.height()}}),b.extend(h.prototype,{$_photoshow:"",_mainImg:"",_renderPhotoShow:function(){var a='<div class="photo_figure_showwarp">						<div class="photo_figure_iwarp" node-type="img-home"></div>						<a href="javascript:;" class="btn btn_left">							<em class="pficon arr_l"></em>						</a>						<a href="javascript:;" class="btn btn_right"><em class="pficon arr_r"></em></a>						<div class="photo_figure_zr">							<a href="javascript:;" class="photo_opbtn" node-type="rotate"><em class="pficon rotate"></em></a>							<a href="javascript:;" class="photo_opbtn" node-type="zoom">								<em class="pficon zoomin"></em>							</a>						</div>						<div class="pfmap" node-type="pf-map"></div>					</div>';this._setHidden();var c=b(a);this.$_photoshow=c,this.$_figbox.append(c),this._showControl()},_showControl:function(){var a=this;this.$_photoshow.on("click","a.btn_left",function(){a.imgListObj.pre()}).on("click","a.btn_right",function(){a.imgListObj.next()}).on("click",'a[node-type="rotate"]',function(){a._mainImg&&(a._mainImg.zoom&&(a._mainImg.zoomOut(),a._setzoomstatus()),a._mainImg.rotate.clockwise())}).on("click",'a[node-type="zoom"]',function(){if(a._mainImg){{b(this)}a._mainImg.zoom?a._mainImg.zoomOut():a._mainImg.zoomIn(),a._setzoomstatus()}}),this.$_photoshow.on("mouseover click",function(){a._imglist.length<2||a.$_photoshow.find("a.btn").show()}).on("mouseout",function(){a._imglist.length<2||a.$_photoshow.find("a.btn").hide()})},_showMainImage:function(a){this._mainImg=new k(a,this),this._setzoomstatus()},_setzoomstatus:function(){var a=this.$_photoshow.find('a[node-type="zoom"]');a.html(this._mainImg.zoom?'<em class="pficon zoomout"></em>':'<em class="pficon zoomin"></em>')},_setBoxSize:function(){var a=920,b=835,c=460,d=420,e=a/b;this.getWinWH();var g=f.winHeight*e-36,h=f.winHeight-20;g>f.winWidth&&(g=f.winWidth),c>g&&(g=c-36),d>h&&(h=minHeix);var i=this.$_warp.find(".photo_figure_main");i.width(g),this.$_photoshow.height(h-155)}}),b.extend(h.prototype,{$_gallary:"",$_viewwarp:"",$ul:"",imgListObj:"",_imglist:"",_renderGallary:function(){var a='<div class="photo_gallary">						<div class="pf_iw" node-type="imgview_warp">							<ul class="galllist clearfix"></ul>						</div>						<div class="gall_btn gall_btn_l">							<a href="javascript:;" class="btn" node-type="btn-l"><em class="pficon l"></em></a>						</div>						<div class="gall_btn gall_btn_r">							<a href="javascript:;" class="btn" node-type="btn-r"><em class="pficon r"></em></a>						</div>					</div>',c=b(a);this.$_gallary=c,this.$_viewwarp=c.find('div[node-type="imgview_warp"]'),this.$ul=c.find("ul"),this.$_figbox.append(c),this._gallaryControl()},add:function(a){if(this.imgListObj){var b=this.filterData(a);this.imgListObj.add(b)}},_gallaryControl:function(){this._gallary_showimg()},_gallary_showimg:function(){var a=this;this._imglist=[],this.imgListObj=new i,this.imgListObj.on("add",function(b){var c=new j(b),d=c.render();a.$_gallary.find("ul.galllist").append(d),a._imglist.push(c),c.on("click",function(b){a.imgListObj.setCurrent(b.data.cindex)}),a._imglist.length>1&&a.$_gallary.show(),a._setGallaryWidth(),a._setGallaryArrow()}).on("pre",function(b){a._gallary_setFocus(b)}).on("next",function(b){a._gallary_setFocus(b)}).on("current",function(b){a._gallary_setFocus(b)}),this.$_gallary.on("click",'a[node-type="btn-l"]',function(){a.imgListObj.pre()}).on("click",'a[node-type="btn-r"]',function(){a.imgListObj.next()}),this.imgListObj.add(this.imgData),a.imgListObj.setCurrent(a.currIndex||0)},_gallary_emititem:function(a){this._gallary_setFocus(a.data.cindex)},_gallary_setFocus:function(a){for(var b=this._imglist,c=0,d=b.length;d>c;c++)b[c].cancelCurrent();b[a].setCurrent(),this._showMainImage(b[a].data),this._slideImgView(a),this.emit("switch",a,b,this)},_slideImgView:function(a){var b=141,c=Math.floor(this.$_viewwarp.width()/b),d=this._imglist.length;if(!(c>d)){var e=Math.floor(a/c),f=e*c,g=(e+1)*c;g>d&&(g=d,f=f-g+d),this.$ul.animate({"margin-left":-(f*b)},200)}},_setGallaryWidth:function(){var a=141,b=this.$_photoshow.width(),c=Math.floor(b/a),d=c*a,e=(b-d)/2;this.$_gallary.width(d),this.$_gallary.css({"margin-left":e,"margin-right":e})},_setGallaryArrow:function(){var a=this._imglist;a.length<2?this.$_gallary.find("a.btn").hide():this.$_gallary.find("a.btn").show()}});var i=function(a){this.dataList=[],this.currIndex=0,this.cindex=0;var b=this;b.add(a)};b.extend(i.prototype,g,{add:function(a){var c=this,d=[];b.isArray(a)?d=d.concat(a):"object"==typeof a&&d.push(a);for(var e=0;e<d.length;e++){var f=d[e];f&&(f.cindex=c.cindex,c.emit("add",f),c.dataList.push(f),this.cindex++)}},traverse:function(a){for(var b,c=0,d=this.dataList.length;d>c;c++)b=this.dataList[c],"function"==typeof a?a(b):""},pre:function(){var a=this.dataList.length;0==this.currIndex?this.currIndex=a-1:this.currIndex-=1,this.emit("pre",this.currIndex)},next:function(){var a=this.dataList.length;this.currIndex==a-1?this.currIndex=0:this.currIndex+=1,this.emit("next",this.currIndex)},setCurrent:function(a){0>a&&(a=0),a>this.dataList.length-1&&(a=this.dataList.length-1),this.currIndex=a,this.emit("current",this.currIndex)}});var j=function(a){this.data=a,this.$el=""};b.extend(j.prototype,g,{render:function(){var a=this,c='<li class="item">						<a href="javascript:;" class="imgb">							<div class="img_warp"><span class="load"></span></div>							<div class="imgchose">								<em class="pf_arrow"></em>							</div>						</a>					</li>';return c=c.replace(/\$\{(.+)\}/i,function(b,c){return a.data[c]}),this.$el=b(c),a.events(),this.$el},events:function(){var a=this;this.$el.on("click",function(){a.emit("click",a)}),this.renderImg()},setCurrent:function(){this.$el.addClass("item_hover")},cancelCurrent:function(){this.$el.removeClass("item_hover")},renderImg:function(){var a=this,b=this.data.smallImg;l("../src/js/resetImgSize.js","resetImgSize",function(c){c({imageUrl:b,style:"min",width:131,height:105},function(b,c){a.setImgAttr(b,c)})})},setImgAttr:function(a,c){var d=b('<img src="'+c+'"  width="'+a[0]+'" height="'+a[1]+'" class="bigPhotoImg" />');a[0]>a[1]?d.css("margin-left",-(a[0]-130)/2):d.css("margin-top",-(a[1]-130)/2),d.css("opacity",0).animate({opacity:1},200),this.$el.find(".img_warp").html(d)}});var k=function(a,b){this.imgdata=a,this.figure=b,this.boxwh={},this.imghome=this.figure.$_photoshow.find('div[node-type="img-home"]'),this.map=this.figure.$_photoshow.find('div[node-type="pf-map"]'),this.zoom=!1,this.init()};b.extend(k.prototype,g,{init:function(){this.map.hide(),this.events(),this.renderImg()},events:function(){var a=this;d.on("resize",function(){a._getWH()}),a._getWH()},_getWH:function(){this.boxwh.width=this.imghome.width(),this.boxwh.height=this.imghome.height()},renderImg:function(){var a=this,b=this.imgdata.bigImg;l("../src/js/resetImgSize.js","resetImgSize",function(c){c({imageUrl:b,style:"max",width:a.boxwh.width,height:a.boxwh.height},function(b,c){a.setImgAttr(b,c)})})},setImgAttr:function(a,c){var d=b('<img src="'+c+'"  width="'+a[0]+'" height="'+a[1]+'" class="bigPhotoImg" />');this.imghome.html(d),this.setImgPos(a,d)},setImgPos:function(a,b){var c=this;a[1]<c.boxwh.height&&b.css("margin-top",(c.boxwh.height-a[1])/2),l("../src/js/rotate.js","rotate",function(d){c.rotate=d({imgObj:b,width:a[0],height:a[1],imgwarp:c.imghome,wwid:c.boxwh.width,whei:c.boxwh.height})})},zoomIn:function(){var a=this,b=(this.boxwh,this.imgdata.bigImg);l("../src/js/resetImgSize.js","resetImgSize",function(c){c({imageUrl:b,style:"min",width:a.boxwh.width,height:a.boxwh.height,zoom:!1},function(b,c){a._setBigImg(b,c)})}),a.zoom=!0},zoomOut:function(){var a=this;a.zoom=!1,a.renderImg(),a.map.hide()},$_bigImg:"",_setBigImg:function(a,b){var c=this;a[0]>this.boxwh.width||a[1]>this.boxwh.height?l("../src/js/resetImgSize.js","resetImgSize",function(a){a({imageUrl:b,style:"max",width:d.width(),height:d.height()},function(a,b){c._insetBigImg(a,b)})}):c._insetBigImg(a,b)},$_bigImgWh:"",_insetBigImg:function(a,c){var d=b('<img src="'+c+'"  width="'+a[0]+'" height="'+a[1]+'" class="bigPhotoImg" />');this.imghome.html(d),this.$_bigImgWh=a,this.$_bigImg=d,this._insertMapImg(a,d,c)},$_mw:"",$_mh:"",_getMapImgSize:function(a,b,c){var d=this;d.map.show(),d.$_mw=d.map.width(),d.$_mh=d.map.height(),l("../src/js/resetImgSize.js","resetImgSize",function(a){a({imageUrl:b,style:"max",width:d.$_mw,height:d.$_mh},function(a,b){c&&c(a,b)})})},_mapinfo:{},_insertMapImg:function(a,c,d){var e=this;e._setBigImgPosition(a,c),a[0]<=e.boxwh.width&&a[1]<=e.boxwh.height||e._getMapImgSize(a,d,function(c,d){var f=b('<img src="'+d+'"  width="'+c[0]+'" height="'+c[1]+'" class="mapImg" />'),g=(e.$_mw-c[0])/2,h=(e.$_mh-c[1])/2;f.css({top:h,left:g}),e.map.html(f),e._mapinfo.imgwid=c[0],e._mapinfo.imghei=c[1],e._mapinfo.imgleft=g,e._mapinfo.imgtop=h,e._getViewArea(a,c),e._initViewareaPos(g,h),e._moveViewEvn()})},_setBigImgPosition:function(a,b){var c=this,d=(c.boxwh.width-a[0])/2,e=(c.boxwh.height-a[1])/2;b.css({top:e,left:d})},$_viewBtn:"",_getViewArea:function(a,c){var d=this,e=c[0]/a[0],f=[];f[0]=this.boxwh.width*e,f[1]=this.boxwh.height*e;var g=b('<p class="viewarea"></p>');g.width(f[0]-6),g.height(f[1]-6),d._mapinfo.areawid=f[0],d._mapinfo.areahei=f[1],this.map.append(g),this.$_viewBtn=g},_initViewareaPos:function(){var a=this._mapinfo,b=(a.areawid-a.imgwid)/2,c=(a.areahei-a.imghei)/2,d=a.imgleft-b,e=a.imgtop-c;a.areatop=e,a.arealeft=d,this.$_viewBtn.css({left:d,top:e})},_moveViewEvn:function(){var a=this;l("../src/js/mousedrag.js","Mousedrag",function(b){var c=new b(a.$_viewBtn,function(b,c,d){a.emit("moving",b,c,d)});c.mousedown(function(){a.emit("moveStart")}),c.mouseup(function(){a.emit("moveEnd")})}),a._moveAreaPos(),a._moveMainImgPos()},_moveAreaPos:function(){var a=this,b=a._mapinfo,c=[0,0],d=a._getRule();this.on("moveStart",function(){}),this.on("moving",function(e,f){var g=b.arealeft+e,h=b.areatop+f;g>d.x[0]&&(g=d.x[0]),g<d.x[1]&&(g=d.x[1]),h<d.y[0]&&(h=d.y[0]),h>d.y[1]&&(h=d.y[1]),c[0]=g,c[1]=h,a.$_viewBtn.css({left:g,top:h}),a.emit("setposition",b.imgleft-g,b.imgtop-h)}),this.on("moveEnd",function(){b.arealeft=c[0],b.areatop=c[1]})},_moveMainImgPos:function(){var a=this,b=this.$_bigImgWh[0]/this._mapinfo.imgwid;this.on("setposition",function(c,d){a.$_bigImg.css({left:c*b,top:d*b})})},_getRule:function(){var a=this,b=a._mapinfo,c={x:[],y:[]},d=b.imgleft,e=b.imgleft-b.areawid+b.imgwid,f=b.imgtop,g=b.imgtop-b.areahei+b.imghei;return c.x[0]=Math.max(d,e),c.x[1]=Math.min(d,e),c.y[0]=Math.min(f,g),c.y[1]=Math.max(f,g),c}});var l=function(c,d,e){a[d]?e&&e(a[d]):b.getScript(c,function(){e&&e(a[d])})};return function(a,b,c){return figureObj=new h(a,b,c)}}),function(a){var b=function(a,b,c,d){var e,f,g,h,i,j=this,k=[],l=null,m=function(){for(var a=0;a<k.length;a++)k[a].end?k.splice(a--,1):k[a]();!k.length&&n()},n=function(){clearInterval(l),l=null},o=new Image;return o.src=a,o.complete?(j.circuGet(o,b),void(c&&c.call(o))):(f=o.width,g=o.height,o.onerror=function(){d&&d.call(o),e.end=!0,o=o.onload=o.onerror=null},e=function(){h=o.width,i=o.height,(h!==f||i!==g||h*i>1024)&&(j.circuGet(o,b),e.end=!0)},e(),o.onload=function(){!e.end&&e(),c&&c.call(o),o=o.onload=o.onerror=null},void(e.end||(k.push(e),null===l&&(l=setInterval(m,40)))))};b.prototype.circuGet=function(a,b){var c,d=0,e=function(){return a.width>0&&a.height>0?void b.call(a):void(d>11||(window.console&&console.log(a," test to get img width and height!!"),c=setTimeout(e,40),d++))};e()},a.preOnloadImgSize=function(a,c,d,e){new b(a,c,d,e)}}(window),function(a,b){var c=function(a,c){var e={};b.extend(e,{zoom:!0},a),d(e,c)},d=function(a,b){e("../src/js/preOnloadImgSize.js","preOnloadImgSize",function(c){c(a.imageUrl,function(){var c;"max"==a.style?c=f(a,this):"min"==a.style&&(c=g(a,this)),b&&b(c,a.imageUrl)})})},e=function(c,d,e){a[d]?e&&e(a[d]):b.getScript(c,function(){e&&e(a[d])})},f=function(a,b){var c,d,e=b.width,f=b.height;if(e<=a.width&&f<=a.height)return[e,f];var g=e/f;return e>=f?e>=a.width?(c=a.width,d=c/g):f>=a.height&&(d=a.height,c=g*d):f>=a.height?(d=a.height,c=g*d):e>=a.width&&(c=a.width,d=c/g),[c,d]},g=function(a,b){var c,d,e=b.width,f=b.height,g=a.width/a.height,h=e/f;return!a.zoom&&e<=a.width&&f<=a.height?[e,f]:(g>h?(c=a.width,d=c/h):(d=a.height,c=h*d),[c,d])};a.resetImgSize=c}(window,$),function(a){function b(a){for(var b in a)this[b]=a[b];this.init()}var c=function(a){var c={imgObj:"",width:0,height:0,reg:0,imgwarp:"",imgObj:""};return $.extend(c,a),new b(c)},d=b.prototype;d.init=function(){var a=this,b=a.imgwarp.find(".figure_img");b[0]&&b.remove();var c=e(this.wwid,this.whie);this.imgwarp.append(c);var d=f(this.imgObj.attr("src"),this.width,this.height),g=h(this.wwid,this.whei,this.width,this.height);this.imgObj.css({opacity:0}),c.append(d.css(g)),this.roImg=d,d.addClass("rotate"),this.rotateImg=this.rotate()},d.rotate=function(){var a=this;return i?function(b){var c,d,e=k+"transform",f=b/90;c=f%2?g(a.whei,a.wwid,a.width,a.height):g(a.wwid,a.whei,a.width,a.height);var d=h(a.wwid,a.whei,c[0],c[1]);a.roImg.css(e,"rotate("+b+"deg)"),a.roImg.css({width:c[0],height:c[1],top:d.top,left:d.left})}:j?function(b){var c,d=Math.PI/180*b,e=Math.sin(d),f=Math.cos(d),i=b/90;i%2?(nwd=g(a.whei,a.wwid,a.width,a.height),c=h(a.wwid,a.whei,nwd[1],nwd[0])):(nwd=g(a.wwid,a.whei,a.width,a.height),c=h(a.wwid,a.whei,nwd[0],nwd[1])),a.roImg.css({width:nwd[0],height:nwd[1],top:c.top,left:c.left});var j=['progid:DXImageTransform.Microsoft.Matrix(M11="',f,'", M12="',-e,'", M21="',e,'", M22="',f,'", sizingMethod="auto expand")'].join("");a.roImg.css("filter",j)}:void 0},d.clockwise=function(){this.reg+=90,this.rotateImg(this.reg)},d.anticlockwise=function(){this.reg-=90,this.rotateImg(this.reg)};var e=function(a,b){return $('<div class="figure_img"></div>').css({position:"absolute",width:a,height:b,top:0,left:0})},f=function(a,b,c){var d=$('<img src="'+a+'" />');return d.css({height:c,width:b,position:"absolute"})},g=function(a,b,c,d){var e,f;if(a>=c&&b>=d)return[c,d];var g=c/d;return c>=d?c>=a?(e=a,f=e/g):d>=b&&(f=b,e=g*f):d>=b?(f=b,e=g*f):c>=a&&(e=a,f=e/g),[e,f]},h=function(a,b,c,d){return{top:(b-d)/2,left:(a-c)/2}},i=function(){var a=document.createElement("canvas");return!(!a||!a.getContext)}(),j=function(){return void 0!==document.createElement("span").style.filter}(),k=function(){var a=navigator.userAgent;return a.indexOf("MSIE")>=0?"-ms-":a.indexOf("OPR")>=0?"-o-":a.indexOf("Firefox")>=0?"-moz-":a.indexOf("Safari")>=0?"-webkit-":a.indexOf("Chrome")>=0?"-webkit-":a.indexOf("Camino")>=0?"":""}();a.rotate=c}(window),function(a,b){var c=b(document),d=function(a,b){this.target=a,this.random=(1e4*Math.random()*8|0).toString(16),this.whenmousedown=null,this.wnenmouseup=null,this.oldPos,this.oldmouse,this.oldLT,this.groupStatus=!1,this.callback=b,this.init()};b.extend(d.prototype,{init:function(){var a=this;this.target.css({cursor:"pointer"}),this.target.on("mousedown."+this.random,function(b){a._mousedown(b),a.oldLT={left:parseInt(a.target.css("left")),top:parseInt(a.target.css("top")),bottom:parseInt(a.target.css("bottom")),right:parseInt(a.target.css("right"))},"function"==typeof a.whenmousedown&&a.whenmousedown(),a.groupStatus=!0,c.on("mousemove."+a.random,function(b){window.getSelection?window.getSelection().removeAllRanges():document.selection.empty(),a.groupStatus&&a._mousemove(b)}).on("mouseup."+a.random,function(){a._mouseup()})})},_mousedown:function(a){a.preventDefault(),a.stopPropagation(),this.groupStatus=!0,this.oldmouse={x:a.clientX,y:a.clientY}},_mousemove:function(a){var b={x:a.clientX,y:a.clientY},c=b.x-this.oldmouse.x,d=b.y-this.oldmouse.y;"function"==typeof this.callback&&this.callback(c,d,this.oldLT)},_mouseup:function(){var a=this;a.groupStatus=!1,c.unbind("mousemove."+a.random),c.unbind("mouseup."+a.random),"function"==typeof a.wnenmouseup&&a.wnenmouseup()},mousedown:function(a){return"function"==typeof a?void(this.whenmousedown=a):void 0},mouseup:function(a){return"function"==typeof a?void(this.wnenmouseup=a):void 0}}),a.Mousedrag=d}(window,$);